{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "Template to create an EC2 Instance and Install Apache Server.",
  "Parameters" : {

    "KeyName" : {
      "Type" : "String",
      "Description" : "Name of an existing EC2 KeyPair to enable SSH access to the web server"
    },

    "InstanceName": {
      "Description": "Name of EC2 instance",
      "Type": "String",
      "ConstraintDescription": "must be a valid EC2 instance string name."
    },

      "InstanceCount": {
        "Description": "Basic EC2 instance count",
        "Type": "String",
        "Default": "1",
        "ConstraintDescription": "must be a valid EC2 instance count."
      },

  },

  "Mappings": {
  },


  "Resources" : {


        "Ec2Instance" : {
          "Type" : "AWS::EC2::Instance",
          "Properties" : {
            "KeyName": {
              "Ref": "KeyName"
            },
            "InstanceType":"t2.micro",
            "ImageId":"ami-0ff8a91507f77f867",
            "UserData": {
                "Fn::Base64": {
                    "Fn::Join": [
                      "",
                        [
                          "#!/bin/bash\n",
                          "yum update -y \n",
                          "yum install httpd24 -y\n",
                          "service httpd start\n",
                          "chkconfig httpd on",
                        ]
                    ]
                }
            },
          }
        },

    "FirstEC2SecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId" : "vpc-1d7cae67",
        "GroupDescription": "First sample security group"
      }
    },

    "SecondEC2SecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId" : "vpc-1d7cae67",
        "GroupDescription": "Second sample security group"
      }
    },

    "OutboundRule": {
      "Type": "AWS::EC2::SecurityGroupEgress",
      "Properties":{
        "IpProtocol": "TCP",
        "FromPort": 0,
        "ToPort": 65535,
        "DestinationSecurityGroupId": {
          "Fn::GetAtt": [
            "SecondEC2SecurityGroup",
            "GroupId"
          ]
        },
        "GroupId": {
          "Fn::GetAtt": [
            "FirstEC2SecurityGroup",
            "GroupId"
          ]
        }
      }
    },

    "InboundRule": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties":{
        "IpProtocol": "TCP",
        "FromPort": 0,
        "ToPort": 65535,
        "SourceSecurityGroupId": {
          "Fn::GetAtt": [
            "FirstEC2SecurityGroup",
            "GroupId"
          ]
        },

        "GroupId": {
          "Fn::GetAtt": [
            "SecondEC2SecurityGroup",
            "GroupId"
          ]
        }
      }
    },

    "SimpleConfig" : {
       "Type" : "AWS::AutoScaling::LaunchConfiguration",
       "Properties" : {
         "KeyName": {
           "Ref": "KeyName"
         },
         "ImageId":"ami-0ff8a91507f77f867",
          "InstanceType":"t2.micro",


          "BlockDeviceMappings" : [
            {
                "DeviceName" : "/dev/xvda",
                "Ebs" : {
                  "VolumeSize" : "8"
                }
             },
             {
                "DeviceName" : "/dev/xvda",
                "VirtualName" : "ephemeral0"
             }
          ]
       }
    }




  },




}
